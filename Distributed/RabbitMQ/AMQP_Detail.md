## AMQP协议详解

原文：https://blog.csdn.net/qq1309664161/article/details/117735003?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-117735003-blog-126130131.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-117735003-blog-126130131.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=1



### 一. 总体介绍

#### 1.1 什么是AMQP协议

AMQP（Advanced Message Queuing Protocol）是一个进程间传递异步消息的恶网络协议。它描述了在网络上传输的数据的格式，以字节为流。因此任何遵守此数据格式的工具，其创建和解释消息，都能 与其他兼容工具进行互操作。

#### 1.2 规模化部署

AMQP 范围涵盖不同等级规模，大致如下：

* 开发/临时使用：1台服务器，1个用户，10个消息队列，每秒1消息
* 产品应用程序：2台服务器，10-100个用户，10-50个消息队列，每秒10个消息（36K messages/hour）
* 部门关键任务应用：4台服务器，100-500个用户，50-100个消息队列，每秒100个消息（360K/hour）
* 区域任务关键应用：16台服务器，500-2000个用户，100-500个消息队列和主题，每秒1000个消息
* 全球任务关键应用：64台服务器，2k-10k个用户，500-1000个消息队列和主题，每秒10000个消息（36M/hour）
* 市场数据（交易）：200台服务器，5K哥用户 ，10K主题，每秒100K个消息

规模越大，消息传输延迟就越严重。例如，市场数据变化相当快，实现可以依据不同的服务管理和管理能力不区分对待，但必须与本规范兼容。

#### 1.3 功能范围

要支持多种消息传递架构：

* 使用多个writers 和一个reader 来存储转发
* 侍弄多个writers 和多个 readers 来分散工作负载
* 使用多个writers 和多个 readers 来发布订阅
* 使用多个writers 和多个 readers 来基于内容路由
* 使用多个writers 和多个 readers 来进行队列文件传输
* 在两个节点之间进行点对点连接
* 使用多个源和多个readers来分布市场数据

由此可知，**AMQP协议可以急性订阅-发布，文件传输，点对点连接等操作**。

#### 1.4 整体架构

![1](./images/AMQP_Detail/1.png)

**Virtual Host**:

虚拟机，消息队列以及相关对象的集合。虚拟机是共享同一个身份验证和加密环境的独立服务器域。

**Exchange**:

服务器中接收来自生产者应用程序的恶消息的实体，并可选择这些消息路由到服务器中的消息队列。

中间件服务器是什么:它是一个接受消息的数据服务器，并主要做两件事情，依据条件将消息路由给不同的消费者,当消费者消费速度不够快时，它会把消息缓存在内存或磁盘上．
在AMQP之前的服务器中，它们会通过实现了特定类型路由和缓存的庞大引擎来完成. AMQ模块使用较小的模块结合更多样和稳健的方案来实现. 它把这些任务分成了两个不同角色:

* 交换器，它接受来自生产者的消息并将它们路由到消息队列
* 消息队列，它存储消息并把它们转发给消费者应用程序

在交换器和消息队列之间有一个明显的界面，称为绑定(binding)。

一句话总结：AMQP的工作原理就是:生产者发送消息到达broker的交换器上，交换器将消息路由到不同的队列中。消费者从队列中获得消息。

上面对AMQP协议做了一个总体的，宏观的介绍，大致了解了AMQP协议。下面，重点讲解AMQP相关的组件和特性。

### 二. 交换器（exchange）和路由器（Routing Key）

#### 2.1 交换器

交换器接收来自生产者应用程序的消息，并将它们按照事先约定的规则(在消息的属性和内容中定义)路由到消息队列中。
这些预先约定的规则或条件称为绑定. 交换器会与路由引擎匹配。
也就是说，它们会检查消息，并使用它们的绑定表来决定如何将这些消息转发到消息队列或其他交换器中。**交换器永远不会存储信息**。“交换器”一词是指一类算法或算法实例。
更确切的说，谈到了交换器类型和交换器实例．
AMQP定义了许多交换器类型，它们覆盖了常见消息路由分发的基础类型。AMQP服务器提供了这些交换器的默认实例.使用AMQP的应用程序可额外创建它们自己的交换器实例。交换器类型是命名的，这样创建交换器的应用程序就可以告知服务器他们使用的交换器类型。
交换器实现也可以是命名的，这样应用程序可指定如何绑定队列来发布消息。
交换器还可以做更多的消息路由。它们可作为服务器内的智能路由代理，按需接受消息和生产消息。交换器概念的目的是定义一套模型或标准，使得可以合理地扩展AMQP服务器，因为可扩展性会对互操作产生影响。



#### 2.2 路由器

### 三. 消息队列（Message Queue）

